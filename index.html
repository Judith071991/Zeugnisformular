<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Zeugnis-Eingabe</title>
  <style>
    :root { --bg:#f6f7fb; --card:#fff; --border:#dcdfe6; --text:#222; --muted:#666; }
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background: var(--bg); color: var(--text); margin: 0; }
    .wrap { max-width: 1100px; margin: 24px auto; padding: 0 16px; }
    h1 { margin: 0 0 6px; font-size: 28px; }
    .sub { color: var(--muted); margin: 0 0 16px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 14px; }
    label { display:block; font-size: 13px; color: var(--muted); margin-bottom: 6px; }
    input, select, button { width: 100%; box-sizing: border-box; padding: 10px; border-radius: 8px; border: 1px solid var(--border); font-size: 14px; background:#fff; }
    button { cursor:pointer; background:#1f6feb; border-color:#1f6feb; color:#fff; font-weight:600; }
    button:disabled { opacity:.5; cursor:not-allowed; }
    .row { display:flex; gap:10px; align-items:center; }
    .row > * { flex: 1; }
    .muted { color: var(--muted); }
    .small { font-size: 13px; }
    .items { max-height: 320px; overflow:auto; border:1px solid var(--border); border-radius:10px; padding:10px; background:#fff; }
    .line { display:grid; grid-template-columns: 24px 1fr 200px; gap:10px; align-items:center; padding:8px 6px; border-bottom:1px solid #eee; }
    .line:last-child { border-bottom:none; }
    .pill { display:inline-block; padding:2px 8px; border:1px solid var(--border); border-radius:999px; font-size:12px; color:var(--muted); }
    .two { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    #status { margin-top: 12px; }
  </style>
</head>
<body>
<div class="wrap">
  <h1>Zeugnis-Eingabe - NEU 01</h1>
  <p class="sub small">Fach → Pool-Jahrgang → Thema → Items laden. Items aus mehreren Pool-Jahrgängen kombinierbar. Speichern erzeugt eine neue Version pro Kind+Fach.</p>

  <div class="card">
    <div class="grid">
      <div>
        <label for="kind_code">Kind-Code</label>
        <input id="kind_code" placeholder="z. B. K05A" />
      </div>
      <div>
        <label for="fach">Fach</label>
        <select id="fach">
          <option value="">— bitte wählen —</option>
        </select>
        <div class="small muted">Die Soll-Anzahl wird automatisch über <span class="pill">track</span> aus der Item-Tabelle bestimmt.</div>
      </div>

      <div>
        <label for="pool_jahrgang">Pool-Jahrgang</label>
        <select id="pool_jahrgang">
          <option value="">— bitte wählen —</option>
          <option>5</option><option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
        </select>
      </div>

      <div>
        <label for="thema">Thema</label>
        <select id="thema" disabled>
          <option value="">— zuerst Fach + Pool-Jahrgang wählen —</option>
        </select>
      </div>
    </div>

    <div style="margin-top:12px;">
      <button id="btn_load" disabled>Items laden</button>
      <div class="small muted" style="margin-top:6px;">Du kannst danach Pool-Jahrgang oder Thema wechseln und weitere Items hinzufügen – der Auswahlkorb bleibt bestehen.</div>
    </div>
  </div>

  <div class="two" style="margin-top:12px;">
    <div class="card">
      <div class="row" style="align-items:flex-end;">
        <div>
          <div style="font-weight:700;">Items zur Auswahl</div>
          <div class="small muted">Häkchen setzen → Bewertung wählen → wird in den Korb übernommen.</div>
        </div>
        <div class="small muted" style="text-align:right;">
          <span id="counter">0</span>/<span id="required">—</span>
        </div>
      </div>
      <div id="items" class="items" style="margin-top:10px;">
        <div class="small muted">Noch keine Items geladen.</div>
      </div>
    </div>

    <div class="card">
      <div style="font-weight:700;">Auswahlkorb <span class="pill">track: <span id="track_lbl">—</span></span></div>
      <div class="small muted">Speichern ist nur möglich, wenn die Soll-Anzahl erreicht ist und alle Bewertungen gesetzt sind.</div>
      <div id="korb" class="items" style="margin-top:10px;"></div>
      <button id="btn_save" disabled style="margin-top:10px;">Speichern (neue Version)</button>
    </div>
  </div>

  <div id="status" class="card small muted">Bereit.</div>
</div>

<!-- Supabase UMD (Safari-stabil) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script>
/** ===========
 *  Konfiguration: HIER eintragen
 *  =========== */
const SUPABASE_URL = "https://nvnjbmviyifslpsgljid.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_py0G-vJVAsuv1k1Cov4CQQ_mPe8ZAli";

/** Tabellen */
const T = {
  fach: "fach",
  thema: "thema",
  item: "item",
  bewertungsskala: "bewertungsskala",
  zeugniseintraege: "zeugniseintraege",
  fachstand: "fachstand",
};
/** Spaltennamen (wie bei dir) */
const C = {
  // fach
  fach_name: "name",
  fach_order: "order",
  // thema
  thema_jahrgang: "jahrgang",
  thema_name: "thema",
  thema_fach: "fach",
  // item
  item_jahrgang: "jahrgang",
  item_thema: "thema",
  item_text: "item",
  item_track: "track",
  item_fach: "fach",
  // bewertungsskala
  b_label: "label",
  b_order: "order",
  // zeugniseintraege
  z_kind: "kind_code",
  z_fach: "fach",
  z_jg: "jahrgang",
  z_thema: "thema",
  z_item: "item",
  z_bew: "bewertungsskala",
  z_eingabe: "eingabe_id",
  z_pool_jg: "pool_jahrgang",
  z_pool_thema: "pool_thema",
  // fachstand
  f_kind: "kind_code",
  f_fach: "fach",
  f_eingabe: "aktuelle_eingabe_id",
  f_updated: "aktualisiert_am",
};

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// DOM
const elStatus = document.getElementById("status");
const elKind = document.getElementById("kind_code");
const elFach = document.getElementById("fach");
const elPoolJg = document.getElementById("pool_jahrgang");
const elThema = document.getElementById("thema");
const elBtnLoad = document.getElementById("btn_load");
const elBtnSave = document.getElementById("btn_save");
const elItems = document.getElementById("items");
const elKorb = document.getElementById("korb");
const elCounter = document.getElementById("counter");
const elRequired = document.getElementById("required");
const elTrackLbl = document.getElementById("track_lbl");

// Zustand
let ratings = []; // {id,label,order}
let currentTrack = null;
let requiredCount = null;
let selected = new Map(); // key=item_id => { itemRow, ratingId, pool_jg, pool_thema }

function logStatus(msg){ elStatus.textContent = msg; }

function sanitizeKindCode(s){
  return (s || "").trim();
}

function updateCounter(){
  elCounter.textContent = String(selected.size);
  elRequired.textContent = requiredCount ? String(requiredCount) : "—";
  elTrackLbl.textContent = currentTrack ?? "—";

  // alle Bewertungen gesetzt?
  const allRated = [...selected.values()].every(v => !!v.ratingId);

  const canSave =
    sanitizeKindCode(elKind.value).length > 0 &&
    !!elFach.value &&
    !!currentTrack &&
    !!requiredCount &&
    selected.size === requiredCount &&
    allRated;

  elBtnSave.disabled = !canSave;
}

function ratingSelectHtml(selectedId){
  let html = `<option value="">— Bewertung —</option>`;
  for (const r of ratings){
    const sel = (r.id === selectedId) ? "selected" : "";
    html += `<option value="${r.id}" ${sel}>${escapeHtml(r[C.b_label])}</option>`;
  }
  return html;
}

function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

async function loadRatings(){
  const { data, error } = await supabase
    .from(T.bewertungsskala)
    .select(`id, ${C.b_label}, ${C.b_order}`)
    .order(C.b_order, { ascending: true });

  if (error) throw error;
  ratings = data || [];
}

async function loadFaecher(){
  logStatus("Lade Fächer…");
  const { data, error } = await supabase
    .from(T.fach)
    .select(`id, ${C.fach_name}, ${C.fach_order}`)
    .order(C.fach_order, { ascending: true });

  if (error) throw error;

  elFach.innerHTML = `<option value="">— bitte wählen —</option>`;
  for (const row of (data || [])){
    const name = row[C.fach_name];
    const opt = document.createElement("option");
    opt.value = name;            // wir speichern den Fach-NAMEN in allen Tabellen
    opt.textContent = name;
    elFach.appendChild(opt);
  }
  logStatus(`✅ Fächer geladen: ${(data||[]).length}`);
}

async function loadThemen(){
  elThema.disabled = true;
  elThema.innerHTML = `<option value="">— lade Themen —</option>`;

  const fach = elFach.value;
  const poolJg = elPoolJg.value;
  if (!fach || !poolJg) {
    elThema.innerHTML = `<option value="">— zuerst Fach + Pool-Jahrgang wählen —</option>`;
    return;
  }

  const { data, error } = await supabase
    .from(T.thema)
    .select(`id, ${C.thema_name}, ${C.thema_jahrgang}, ${C.thema_fach}`)
    .eq(C.thema_fach, fach)
    .eq(C.thema_jahrgang, Number(poolJg))
    .order(C.thema_name, { ascending: true });

  if (error) throw error;

  elThema.innerHTML = `<option value="">— Thema wählen —</option>`;
  for (const row of (data || [])){
    const tname = row[C.thema_name];
    const opt = document.createElement("option");
    opt.value = tname;
    opt.textContent = tname;
    elThema.appendChild(opt);
  }
  elThema.disabled = false;
}

async function detectTrackAndRequired(fach){
  // Track ermitteln: wir nehmen den häufigsten track für dieses Fach (praktisch: pro Fach ist track konstant)
  const { data, error } = await supabase
    .from(T.item)
    .select(`id, ${C.item_track}, ${C.item_fach}`)
    .eq(C.item_fach, fach)
    .limit(2000);

  if (error) throw error;

  const counts = new Map();
  for (const row of (data||[])){
    const tr = row[C.item_track] || null;
    if (!tr) continue;
    counts.set(tr, (counts.get(tr) || 0) + 1);
  }
  // fallback
  const best = [...counts.entries()].sort((a,b)=>b[1]-a[1])[0]?.[0] || null;
  currentTrack = best;

  // Soll-Zahl je Track (du kannst das später anpassen)
  // Idee: track in item: "nebenfach" -> 5, "hauptfach" -> 7, "arbeitsverhalten"/"sozialverhalten" -> 8
  const map = {
    nebenfach: 5,
    hauptfach: 7,
    arbeitsverhalten: 8,
    sozialverhalten: 8,
  };
  requiredCount = map[currentTrack] ?? null;
  updateCounter();
}

async function loadItems(){
  const fach = elFach.value;
  const poolJg = elPoolJg.value;
  const thema = elThema.value;

  if (!fach || !poolJg || !thema){
    logStatus("Bitte Fach, Pool-Jahrgang und Thema wählen.");
    return;
  }

  await detectTrackAndRequired(fach);

  logStatus("Lade Items…");

  const { data, error } = await supabase
    .from(T.item)
    .select(`id, ${C.item_text}, ${C.item_track}, ${C.item_jahrgang}, ${C.item_thema}, ${C.item_fach}`)
    .eq(C.item_fach, fach)
    .eq(C.item_jahrgang, Number(poolJg))
    .eq(C.item_thema, thema)
    .order(C.item_text, { ascending: true });

  if (error) throw error;

  elItems.innerHTML = "";
  const rows = data || [];
  if (!rows.length){
    elItems.innerHTML = `<div class="small muted">Keine Items gefunden.</div>`;
    logStatus("Keine Items für diese Auswahl.");
    return;
  }

  for (const row of rows){
    const id = row.id;
    const txt = row[C.item_text];

    const line = document.createElement("div");
    line.className = "line";

    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.checked = selected.has(id);

    const textDiv = document.createElement("div");
    textDiv.textContent = txt;

    const sel = document.createElement("select");
    sel.innerHTML = ratingSelectHtml(selected.get(id)?.ratingId || "");
    sel.disabled = !cb.checked;

    cb.addEventListener("change", () => {
      if (cb.checked){
        selected.set(id, { itemRow: row, ratingId: "", pool_jg: Number(poolJg), pool_thema: thema });
        sel.disabled = false;
      } else {
        selected.delete(id);
        sel.disabled = true;
        sel.value = "";
      }
      renderKorb();
      updateCounter();
    });

    sel.addEventListener("change", () => {
      if (!selected.has(id)) return;
      const entry = selected.get(id);
      entry.ratingId = sel.value || "";
      selected.set(id, entry);
      renderKorb();
      updateCounter();
    });

    line.appendChild(cb);
    line.appendChild(textDiv);
    line.appendChild(sel);
    elItems.appendChild(line);
  }

  renderKorb();
  updateCounter();
  logStatus(`✅ Items geladen: ${rows.length}`);
}

function renderKorb(){
  elKorb.innerHTML = "";
  if (!selected.size){
    elKorb.innerHTML = `<div class="small muted">Noch keine Auswahl.</div>`;
    return;
  }
  for (const [id, v] of selected.entries()){
    const row = v.itemRow;
    const txt = row[C.item_text];
    const wrap = document.createElement("div");
    wrap.className = "line";
    wrap.style.gridTemplateColumns = "1fr 200px 110px";

    const t = document.createElement("div");
    t.textContent = txt;

    const sel = document.createElement("select");
    sel.innerHTML = ratingSelectHtml(v.ratingId || "");
    sel.addEventListener("change", () => {
      const e = selected.get(id);
      e.ratingId = sel.value || "";
      selected.set(id, e);
      updateCounter();
    });

    const btn = document.createElement("button");
    btn.textContent = "Entfernen";
    btn.style.background = "#444";
    btn.style.borderColor = "#444";
    btn.addEventListener("click", () => {
      selected.delete(id);
      renderKorb();
      updateCounter();
      // Checkbox-Liste nicht automatisch neu gebaut, das ist ok für V1
    });

    wrap.appendChild(t);
    wrap.appendChild(sel);
    wrap.appendChild(btn);
    elKorb.appendChild(wrap);
  }
}

async function saveNewVersion(){
  const kind = sanitizeKindCode(elKind.value);
  const fach = elFach.value;
  if (!kind || !fach) {
    logStatus("Bitte Kind-Code und Fach setzen.");
    return;
  }
  if (!currentTrack || !requiredCount){
    logStatus("Track/Soll-Anzahl nicht ermittelt. Bitte Items laden.");
    return;
  }
  if (selected.size !== requiredCount){
    logStatus(`Bitte genau ${requiredCount} Items wählen (aktuell ${selected.size}).`);
    return;
  }
  const allRated = [...selected.values()].every(v => !!v.ratingId);
  if (!allRated){
    logStatus("Bitte für alle ausgewählten Items eine Bewertung setzen.");
    return;
  }

  // neue Version-ID
  const eingabe_id = crypto.randomUUID();

  // Zeugniseinträge vorbereiten
  const rows = [];
  for (const v of selected.values()){
    const it = v.itemRow;
    rows.push({
      [C.z_kind]: kind,
      [C.z_fach]: fach,
      [C.z_jg]: it[C.item_jahrgang],
      [C.z_thema]: it[C.item_thema],
      [C.z_item]: it[C.item_text],
      [C.z_bew]: v.ratingId,
      [C.z_eingabe]: eingabe_id,
      [C.z_pool_jg]: v.pool_jg,
      [C.z_pool_thema]: v.pool_thema,
    });
  }

  logStatus("Speichere…");

  // 1) in fachstand upsert: aktuelle_eingabe_id pro kind+fach
  // -> setzt den "Zeiger" auf die neueste Version.
  const up1 = await supabase
    .from(T.fachstand)
    .upsert({
      [C.f_kind]: kind,
      [C.f_fach]: fach,
      [C.f_eingabe]: eingabe_id,
      [C.f_updated]: new Date().toISOString()
    }, { onConflict: `${C.f_kind},${C.f_fach}` });

  if (up1.error) { logStatus("❌ fachstand Fehler: " + up1.error.message); return; }

  // 2) zeugniseintraege einfügen
  const ins = await supabase
    .from(T.zeugniseintraege)
    .insert(rows);

  if (ins.error) { logStatus("❌ Einfügen Fehler: " + ins.error.message); return; }

  logStatus("✅ Gespeichert. Neue Version-ID: " + eingabe_id + " (du kannst weiter Items hinzufügen oder Fach wechseln).");
}

function onSelectionChange(){
  const fach = elFach.value;
  const poolJg = elPoolJg.value;
  elBtnLoad.disabled = !(fach && poolJg);
  elThema.disabled = !(fach && poolJg);
  if (fach && poolJg){
    loadThemen().catch(e => logStatus("❌ Themen Fehler: " + (e.message ?? e)));
  }
}

elFach.addEventListener("change", () => {
  currentTrack = null;
  requiredCount = null;
  selected.clear();
  renderKorb();
  updateCounter();
  onSelectionChange();
});
elPoolJg.addEventListener("change", onSelectionChange);
elThema.addEventListener("change", () => {
  elBtnLoad.disabled = !(elFach.value && elPoolJg.value && elThema.value);
});
elBtnLoad.addEventListener("click", () => {
  loadItems().catch(e => logStatus("❌ Items Fehler: " + (e.message ?? e)));
});
elBtnSave.addEventListener("click", () => {
  saveNewVersion().catch(e => logStatus("❌ Speichern Fehler: " + (e.message ?? e)));
});

// Init
(async function init(){
  try{
    logStatus("Init…");
    await loadRatings();
    await loadFaecher();
    logStatus("Bereit. Wähle Fach, Pool-Jahrgang, Thema → Items laden.");
  }catch(e){
    logStatus("❌ INIT Fehler: " + (e.message ?? String(e)));
  }
})();
</script>
</body>
</html>
